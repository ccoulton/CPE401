import sys
import socket
import string
import time
import datetime
import re
from threading import Thread
class clientHandler(Thread):
    def __init__(self, socket, addr):
        Thread.__init__(self, name = "ClientHndlr")
        self._sock = socket
        self._addr = addr
        
    def run(self):
        data = self._sock.recv(1024)
        print data
        sdata = data.split(' ')
        if sdata[0].find('REGISTER') != -1:
            outstr = "ACK "+sdata[1]+" "+self._addr[0]+" "+repr(self._addr[1])
            print outstr
            self._sock.send(outstr)
            self._sock.close()
#parse activty log, populate users list, 
#should be started with a port number
print "press ctrl +z to quit"
TCP = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
TCP.bind(('localhost', int(sys.argv[1])))
TCP.listen(5)

while True:
    sock, addr = TCP.accept()
    print "Connected to", addr
    Client = clientHandler(sock, addr)
    Client.start()
'''
    #check for what action to take
    #if register add to registry
        #send ACK
    #if login record address, and port and update user table
    #if quit check ip matches user and drop from user table
    #if requesting friendship with user2 
        #send wall message to user2 asking for friendshop
    #if reject, do not relay message
    #if chat user-id mes send message to user-id
        #if on relay, if off respond offline
        #once delievered send delievered message
    #if post wall post to friends and fof or pub can see
    #if search, use regx to find results in profiles
        #return results msg w/ file len, in xml
    #if entries get all wall posts since time in reverse order
        #return wall message w/ file len, in xml
'''
